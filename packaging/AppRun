#!/bin/bash
# AppRun wrapper for Mesh applications
# Auto-detects PipeWire vs JACK and configures audio accordingly

APPDIR="$(dirname "$(readlink -f "$0")")"
BINARY_NAME="$(basename "$0" .AppImage)"

# If called as the AppImage itself, determine which binary to run
if [[ "$BINARY_NAME" == "AppRun" ]]; then
    # Check if mesh-player exists, otherwise try mesh-cue
    if [[ -x "$APPDIR/usr/bin/mesh-player" ]]; then
        BINARY_NAME="mesh-player"
    elif [[ -x "$APPDIR/usr/bin/mesh-cue" ]]; then
        BINARY_NAME="mesh-cue"
    else
        echo "Error: No mesh binary found in AppImage"
        exit 1
    fi
fi

# Detect PipeWire and configure JACK compatibility
if [[ -S "${XDG_RUNTIME_DIR:-/run/user/$UID}/pipewire-0" ]]; then
    # PipeWire is running - use pipewire-jack libraries
    # The pipewire-jack libs provide a drop-in replacement for libjack
    export LD_LIBRARY_PATH="$APPDIR/usr/lib/pipewire-0.3/jack:$APPDIR/usr/lib:$LD_LIBRARY_PATH"
    echo "[Mesh] Using PipeWire JACK compatibility layer"
else
    # No PipeWire - use standard JACK libraries
    # Requires JACK server to be running (jackd or qjackctl)
    export LD_LIBRARY_PATH="$APPDIR/usr/lib:$LD_LIBRARY_PATH"
    echo "[Mesh] Using native JACK (ensure JACK server is running)"
fi

# Set up other environment variables
export XDG_DATA_DIRS="$APPDIR/usr/share:${XDG_DATA_DIRS:-/usr/local/share:/usr/share}"

# Vulkan ICD discovery for GPU rendering
if [[ -d "$APPDIR/usr/share/vulkan/icd.d" ]]; then
    export VK_ICD_FILENAMES="$APPDIR/usr/share/vulkan/icd.d/*.json:${VK_ICD_FILENAMES:-}"
fi

# Execute the binary
exec "$APPDIR/usr/bin/$BINARY_NAME" "$@"
