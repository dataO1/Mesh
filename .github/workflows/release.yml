name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  build-appimage:
    name: Build AppImages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            # Allow building larger packages
            max-jobs = auto
            cores = 0

      # Optional: Set up Cachix for faster builds
      # Uncomment and configure if you have a Cachix cache
      # - name: Setup Cachix
      #   uses: cachix/cachix-action@v15
      #   with:
      #     name: mesh-dj
      #     authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Build mesh-player
        run: |
          echo "Building mesh-player..."
          nix build .#mesh-player --print-build-logs

      - name: Build mesh-cue
        run: |
          echo "Building mesh-cue..."
          nix build .#mesh-cue --print-build-logs

      - name: Bundle mesh-player AppImage
        run: |
          echo "Bundling mesh-player AppImage..."
          nix bundle --bundler .#default .#mesh-player -o mesh-player-x86_64.AppImage
          chmod +x mesh-player-x86_64.AppImage

      - name: Bundle mesh-cue AppImage
        run: |
          echo "Bundling mesh-cue AppImage..."
          nix bundle --bundler .#default .#mesh-cue -o mesh-cue-x86_64.AppImage
          chmod +x mesh-cue-x86_64.AppImage

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Mesh ${{ steps.version.outputs.version }}
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
          generate_release_notes: true
          files: |
            mesh-player-x86_64.AppImage
            mesh-cue-x86_64.AppImage
          body: |
            ## Installation

            ### AppImage (Linux)

            1. Download the AppImage for your application
            2. Make it executable: `chmod +x mesh-player-x86_64.AppImage`
            3. Run: `./mesh-player-x86_64.AppImage`

            The AppImage automatically detects PipeWire or JACK and configures audio accordingly.

            **Requirements:**
            - PipeWire (Ubuntu 22.04+, Fedora 34+) OR JACK2 audio server
            - GPU drivers for Vulkan (optional, falls back to software rendering)

            ### NixOS

            ```bash
            nix run github:${{ github.repository }}#mesh-player
            nix run github:${{ github.repository }}#mesh-cue
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Optional: Test the AppImages work
  test-appimage:
    name: Test AppImages
    needs: build-appimage
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: mesh-*-x86_64.AppImage
          merge-multiple: true
        continue-on-error: true  # May not have artifacts if using release directly

      - name: Install FUSE
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse libfuse2

      - name: Test mesh-player starts
        run: |
          if [[ -f mesh-player-x86_64.AppImage ]]; then
            chmod +x mesh-player-x86_64.AppImage
            timeout 5 ./mesh-player-x86_64.AppImage --help || true
            echo "mesh-player AppImage is executable"
          fi
        continue-on-error: true

      - name: Test mesh-cue starts
        run: |
          if [[ -f mesh-cue-x86_64.AppImage ]]; then
            chmod +x mesh-cue-x86_64.AppImage
            timeout 5 ./mesh-cue-x86_64.AppImage --help || true
            echo "mesh-cue AppImage is executable"
          fi
        continue-on-error: true
