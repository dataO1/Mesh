name: Release

on:
  push:
    tags:
      - 'v*'
  # Allow manual trigger with pre-built AppImages
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.1.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  # Option 1: Full build on GitHub (for public repos with unlimited minutes)
  # Uncomment this job if you want CI to build the AppImages
  # build-appimage:
  #   name: Build AppImages
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         submodules: recursive
  #     - uses: cachix/install-nix-action@v27
  #       with:
  #         nix_path: nixpkgs=channel:nixos-unstable
  #         extra_nix_config: |
  #           experimental-features = nix-command flakes
  #     - name: Build and bundle AppImages
  #       run: |
  #         nix build .#mesh-player .#mesh-cue --print-build-logs
  #         nix bundle --bundler .#default .#mesh-player -o mesh-player-x86_64.AppImage
  #         nix bundle --bundler .#default .#mesh-cue -o mesh-cue-x86_64.AppImage
  #         chmod +x *.AppImage
  #     - uses: softprops/action-gh-release@v2
  #       with:
  #         files: |
  #           mesh-player-x86_64.AppImage
  #           mesh-cue-x86_64.AppImage

  # Option 2: Create release placeholder for manual uploads
  # Build locally and upload with: gh release upload <tag> <files>
  create-release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Mesh ${{ steps.version.outputs.version }}
          tag_name: ${{ steps.version.outputs.version }}
          draft: true  # Draft so you can upload files before publishing
          prerelease: ${{ contains(steps.version.outputs.version, '-rc') || contains(steps.version.outputs.version, '-beta') || contains(steps.version.outputs.version, '-alpha') }}
          generate_release_notes: true
          body: |
            ## Installation

            ### AppImage (Linux)

            1. Download the AppImage for your application
            2. Make it executable: `chmod +x mesh-player-x86_64.AppImage`
            3. Run: `./mesh-player-x86_64.AppImage`

            The AppImage automatically detects PipeWire or JACK and configures audio accordingly.

            **Requirements:**
            - PipeWire (Ubuntu 22.04+, Fedora 34+) OR JACK2 audio server
            - GPU drivers for Vulkan (optional, falls back to software rendering)

            ### NixOS

            ```bash
            nix run github:${{ github.repository }}#mesh-player
            nix run github:${{ github.repository }}#mesh-cue
            ```

            ---
            *Upload AppImages using: `gh release upload ${{ steps.version.outputs.version }} mesh-player-x86_64.AppImage mesh-cue-x86_64.AppImage`*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
